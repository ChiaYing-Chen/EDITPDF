import{r as d,j as e,R as $t,a as Et}from"./react-vendor-CZCVrs6B.js";import{_ as zt,a as Ge,P as Ft,d as Bt}from"./pdf-Bb0zdt5h.js";import{D as Wt}from"./dexie-CoGj-NRt.js";(function(){const D=document.createElement("link").relList;if(D&&D.supports&&D.supports("modulepreload"))return;for(const w of document.querySelectorAll('link[rel="modulepreload"]'))p(w);new MutationObserver(w=>{for(const y of w)if(y.type==="childList")for(const O of y.addedNodes)O.tagName==="LINK"&&O.rel==="modulepreload"&&p(O)}).observe(document,{childList:!0,subtree:!0});function j(w){const y={};return w.integrity&&(y.integrity=w.integrity),w.referrerPolicy&&(y.referrerPolicy=w.referrerPolicy),w.crossOrigin==="use-credentials"?y.credentials="include":w.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function p(w){if(w.ep)return;w.ep=!0;const y=j(w);fetch(w.href,y)}})();var Te=(a=>(a[a.LOW=.5]="LOW",a[a.NORMAL=.75]="NORMAL",a[a.HIGH=.92]="HIGH",a))(Te||{});zt.workerSrc="https://esm.sh/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs";const qe=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),Tt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})}),Ut=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"})}),Je=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),Ve=({className:a})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}),Ze=({className:a})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M9 11l3 3L22 4"}),e.jsx("path",{d:"M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"})]}),_t=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"})}),At=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3"})}),Qe=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),et=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19.5 12a7.5 7.5 0 11-7.5-7.5M19.5 4.5v3h-3"})}),Yt=({className:a})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"6",cy:"6",r:"3"}),e.jsx("circle",{cx:"6",cy:"18",r:"3"}),e.jsx("line",{x1:"20",y1:"4",x2:"8.12",y2:"15.88"}),e.jsx("line",{x1:"14.47",y1:"14.48",x2:"20",y2:"20"}),e.jsx("line",{x1:"8.12",y1:"8.12",x2:"12",y2:"12"})]}),Ht=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"})}),Xt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),Vt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 12h18",transform:"rotate(45 12 12)"})}),Zt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 12l-7-7m7 7l-7 7m7-7H5"})}),Kt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4h16v16H4z"})}),Gt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeWidth:"2"})}),qt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("text",{x:"12",y:"17",fontSize:"18",textAnchor:"middle",fontFamily:"Arial, sans-serif",children:"文"})}),Jt=({className:a})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9"}),e.jsx("text",{x:"12",y:"15",textAnchor:"middle",fontSize:"8",fill:"currentColor",stroke:"none",fontWeight:"bold",children:"100"})]}),tt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})}),Qt=({className:a})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})}),ve=new Wt("PDFEditorDB");ve.version(1).stores({projects:"id, name, timestamp"});const ue={getProjectsMetadata:async()=>(await ve.projects.orderBy("timestamp").reverse().toArray()).map(({id:D,name:j,timestamp:p,pages:w})=>({id:D,name:j,timestamp:p,pageCount:w.length})),getProjectData:a=>ve.projects.get(a),saveProject:a=>ve.projects.put(a),deleteProject:a=>ve.projects.delete(a)},We=()=>{const[a,D]=d.useState(!1),j=d.useRef(null);return d.useEffect(()=>{const y=O=>{j.current&&!j.current.contains(O.target)&&D(!1)};return document.addEventListener("mousedown",y),()=>document.removeEventListener("mousedown",y)},[]),{isOpen:a,ref:j,toggle:()=>D(!a),close:()=>D(!1)}},Ke=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899","#6366F1","#14B8A6"],es=({files:a,onCancel:D,onConfirm:j})=>{const[p,w]=d.useState([]);d.useEffect(()=>{const h=a.map((M,k)=>({id:`file_${Date.now()}_${k}`,file:M,name:M.name,color:Ke[k%Ke.length]}));w(h)},[a]);const y=(h,M)=>{const k=[...p],[$]=k.splice(h,1);k.splice(h+M,0,$),w(k)},O=(h,M)=>{w(k=>k.map($=>$.id===h?{...$,color:M}:$))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 text-white",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"合併設定：文件排序與標記"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"請調整文件順序，並設定顏色以便在後續步驟中識別。"}),e.jsx("div",{className:"max-h-[60vh] overflow-y-auto space-y-2 mb-6 pr-2",children:p.map((h,M)=>e.jsxs("div",{className:"flex items-center bg-gray-700 p-3 rounded border-l-4",style:{borderColor:h.color},children:[e.jsxs("div",{className:"flex flex-col gap-1 mr-2",children:[e.jsx("button",{onClick:()=>y(M,-1),disabled:M===0,className:"text-gray-400 hover:text-white disabled:opacity-30",children:"▲"}),e.jsx("button",{onClick:()=>y(M,1),disabled:M===p.length-1,className:"text-gray-400 hover:text-white disabled:opacity-30",children:"▼"})]}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsx("p",{className:"truncate font-medium",children:h.name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[(h.file.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx("div",{className:"flex items-center gap-2 ml-3",children:e.jsx("input",{type:"color",value:h.color,onChange:k=>O(h.id,k.target.value),className:"w-8 h-8 rounded cursor-pointer bg-transparent border-none"})})]},h.id))}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:D,className:"px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 text-white",children:"取消"}),e.jsx("button",{onClick:()=>j(p),className:"px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold",children:"開始合併處理"})]})]})})},ts=({sortedFiles:a,onSave:D,onCancel:j})=>{const[p,w]=d.useState([]),[y,O]=d.useState(!0),[h,M]=d.useState(""),[k,$]=d.useState(null),[S,G]=d.useState(`合併專案-${new Date().toLocaleDateString()}`),[Y,W]=d.useState(new Map);d.useEffect(()=>{(async()=>{O(!0);const g=[];try{for(let c=0;c<a.length;c++){const u=a[c];M(`正在處理檔案 (${c+1}/${a.length}): ${u.name}`);const N=await u.file.arrayBuffer(),T=await Ge({data:N}).promise;for(let b=1;b<=T.numPages;b++){const I=await T.getPage(b),Z=I.getViewport({scale:1}),B=document.createElement("canvas"),U=B.getContext("2d");if(!U)continue;B.width=Z.width,B.height=Z.height;const J={canvasContext:U,viewport:Z,canvas:B};await I.render(J).promise;const C=await new Promise(_=>B.toBlob(_,"image/jpeg",Te.NORMAL));C&&g.push({id:`merge_p_${c}_${b}_${Date.now()}`,data:C,originalFileId:u.id,originalPageNum:b,color:u.color,rotation:0})}}w(g)}catch(c){console.error("Merge processing error:",c),alert("處理 PDF 時發生錯誤，請重試。"),j()}finally{O(!1)}})()},[a,j]),d.useEffect(()=>{const f=new Map;return p.forEach(g=>{f.set(g.id,URL.createObjectURL(g.data))}),W(f),()=>{f.forEach(g=>URL.revokeObjectURL(g))}},[p]);const xe=(f,g)=>{$(g),f.dataTransfer.effectAllowed="move";const c=f.currentTarget;c.style.opacity="0.5"},q=f=>{$(null),f.currentTarget.style.opacity="1"},F=(f,g)=>{if(f.preventDefault(),k===null||k===g)return;const c=[...p],[u]=c.splice(k,1);c.splice(g,0,u),w(c),$(g)},je=()=>{const f=p.map((c,u)=>({id:`page_${Date.now()}_${u}`,data:c.data,rotation:c.rotation,objects:[]})),g={id:`proj_merge_${Date.now()}`,name:S,pages:f,timestamp:Date.now()};D(g)},ie=f=>{const g=[...p];g.splice(f,1),w(g)},ee=f=>{const g=[...p];g[f].rotation=(g[f].rotation+90)%360,w(g)};return y?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-gray-900 text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500 mb-4"}),e.jsx("p",{className:"text-lg",children:h})]}):e.jsxs("div",{className:"flex flex-col h-screen bg-gray-900 text-white",children:[e.jsxs("header",{className:"bg-gray-800 shadow-md p-4 flex items-center justify-between sticky top-0 z-20",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(tt,{className:"w-6 h-6 text-purple-400"}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-lg",children:"頁面排序與合併"}),e.jsx("p",{className:"text-xs text-gray-400",children:"拖曳頁面以調整順序，顏色框代表不同原始檔案。"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"text",value:S,onChange:f=>G(f.target.value),className:"bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm w-64",placeholder:"專案名稱"}),e.jsx("button",{onClick:j,className:"px-4 py-2 text-gray-300 hover:text-white",children:"取消"}),e.jsx("button",{onClick:je,className:"px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded font-bold shadow-lg",children:"完成合併"})]})]}),e.jsx("main",{className:"flex-grow overflow-y-auto p-6",children:p.length===0?e.jsx("div",{className:"text-center text-gray-500 mt-20",children:"沒有頁面。"}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4",children:p.map((f,g)=>e.jsxs("div",{draggable:!0,onDragStart:c=>xe(c,g),onDragEnd:q,onDragOver:c=>F(c,g),className:"relative group bg-gray-800 rounded transition-transform",children:[e.jsx("div",{className:"p-2 rounded-t border-4 border-b-0",style:{borderColor:f.color},children:e.jsxs("div",{className:"aspect-[3/4] bg-gray-700 flex items-center justify-center overflow-hidden relative",children:[e.jsx("img",{src:Y.get(f.id),alt:`Page ${g+1}`,className:"max-w-full max-h-full object-contain",style:{transform:`rotate(${f.rotation}deg)`}}),e.jsxs("div",{className:"absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>ee(g),className:"p-1.5 bg-gray-700 rounded-full hover:bg-gray-600 text-white",title:"旋轉",children:e.jsx(et,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ie(g),className:"p-1.5 bg-red-600 rounded-full hover:bg-red-500 text-white",title:"刪除",children:e.jsx(Je,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"bg-gray-800 p-2 rounded-b border-4 border-t-0 text-center",style:{borderColor:f.color},children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("span",{className:"inline-block w-3 h-3 rounded-full",style:{backgroundColor:f.color}}),e.jsxs("span",{className:"text-xs font-mono text-gray-300",children:["原始: P.",f.originalPageNum]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["新頁碼: ",g+1]})]})]},f.id))})})]})},ss=({project:a,onSave:D,onClose:j})=>{var Xe;const[p,w]=d.useState([{...a,pages:a.pages.map(t=>({...t,rotation:t.rotation??0,objects:t.objects||[]}))}]),[y,O]=d.useState(0),h=p[y],[M,k]=d.useState(new Map),$=d.useRef(new Map),[S,G]=d.useState(new Set(a.pages.length>0?[a.pages[0].id]:[])),[Y,W]=d.useState(null),[xe,q]=d.useState(!1),[F,je]=d.useState(a.name),[ie,ee]=d.useState(!1),[f,g]=d.useState(!1),[c,u]=d.useState("view"),[N,T]=d.useState(((Xe=h.pages[0])==null?void 0:Xe.id)||null),[b,I]=d.useState(1),[Z,B]=d.useState({x:0,y:0}),[U,J]=d.useState(!1),[C,_]=d.useState("move"),[m,A]=d.useState({type:"idle"}),[H,le]=d.useState(null),[Pe,K]=d.useState(null),[X,Le]=d.useState({show:!1,x:0,y:0,value:""}),[nt,ot]=d.useState(0),[te,rt]=d.useState("#FF0000"),[ge,Ue]=d.useState("transparent"),[Ne,at]=d.useState(2),[ke,it]=d.useState(16),[De,lt]=d.useState("sans-serif"),me=d.useRef(null),Ie=d.useRef(null),Oe=d.useRef(null),ct=d.useRef(null),Re=d.useRef(new Map),ce=d.useRef({isPinching:!1,initialDist:0,initialZoom:1}),se=We(),pe=We(),fe=We(),P=h.pages.find(t=>t.id===N)||h.pages[0],Ce=h.pages.findIndex(t=>t.id===N),Se=(P==null?void 0:P.objects.find(t=>t.id===Pe))||null,Q=C&&C!=="move";d.useEffect(()=>{const t=$.current,s=new Map;let n=!1;h.pages.forEach(o=>{if(t.has(o.id))s.set(o.id,t.get(o.id));else if(o.data instanceof Blob){const r=URL.createObjectURL(o.data);s.set(o.id,r),n=!0}}),t.size!==s.size&&(n=!0),t.forEach((o,r)=>{s.has(r)||(URL.revokeObjectURL(o),n=!0)}),$.current=s,n&&k(new Map(s))},[h.pages]),d.useEffect(()=>()=>{$.current.forEach(t=>URL.revokeObjectURL(t))},[]);const de=(t,s={})=>{const n=p.slice(0,y+1);for(n.push(t);n.length>11;)n.shift();w(n),O(n.length-1),ee(!0),s.keepSelection||K(null)},$e=()=>{y>0&&(O(t=>t-1),K(null))},dt=()=>{y<p.length-1&&(O(t=>t+1),K(null))},Ee=y>0,ht=y<p.length-1,_e=async t=>{try{const s=await Ft.create();for(const o of t){const r=document.createElement("canvas"),l=r.getContext("2d"),i=new Image,x=await new Promise((oe,he)=>{i.onload=()=>{r.width=i.naturalWidth,r.height=i.naturalHeight,l.drawImage(i,0,0);const ae=1,ye=1;(o.objects||[]).forEach(be=>{Be(l,be,{scaleX:ae,scaleY:ye})}),oe(r.toDataURL("image/jpeg",.92))},i.onerror=()=>he(new Error("Image failed to load for PDF generation"));const re=M.get(o.id);if(!re){he(new Error(`Could not find URL for page ${o.id}`));return}i.src=re}),v=await fetch(x).then(oe=>oe.arrayBuffer()),L=await s.embedJpg(v),{width:V,height:E}=L,z=o.rotation===90||o.rotation===270,ne=s.addPage(z?[E,V]:[V,E]),R={width:L.width,height:L.height,rotate:Bt(-o.rotation)};o.rotation===90?(R.x=L.width,R.y=0):o.rotation===180?(R.x=L.width,R.y=L.height):o.rotation===270&&(R.x=0,R.y=L.height),ne.drawImage(L,R)}const n=await s.save();return new Blob([n],{type:"application/pdf"})}catch(s){return console.error("Failed to generate PDF blob:",s),null}},Ae=async(t,s)=>{q(!0);try{const n=await _e(t);if(!n)return alert("產生 PDF 失敗。"),!1;const o=URL.createObjectURL(n),r=document.createElement("a");return r.href=o,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),!0}catch(n){return console.error("Failed to generate PDF:",n),alert("產生 PDF 失敗。"),!1}finally{q(!1)}},ze=async()=>{se.close();const t={id:h.id,name:F,pages:h.pages,timestamp:Date.now()};await D(t,F),ee(!1),await Ae(h.pages,`${F.replace(/\.pdf$/i,"")||"document"}.pdf`)&&(g(!0),setTimeout(()=>g(!1),2e3))},ut=async()=>{se.close();const t={id:h.id,name:F,pages:h.pages,timestamp:Date.now()};await D(t,F),ee(!1),q(!0);const s=await _e(h.pages);if(q(!1),!s){alert("產生分享檔案失敗。");return}const n=`${F.replace(/\.pdf$/i,"")||"document"}.pdf`,o=new File([s],n,{type:"application/pdf"});if(navigator.canShare&&navigator.canShare({files:[o]}))try{await navigator.share({files:[o],title:F,text:"這是使用 PDF 編輯工具製作的文件，請查收。"})}catch(r){if(r.name!=="AbortError"){console.error("Share failed:",r),alert("分享失敗，將為您下載檔案。");const l=URL.createObjectURL(s),i=document.createElement("a");i.href=l,i.download=n,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l)}}else{alert("您的瀏覽器不支援直接分享檔案，將為您下載檔案。");const r=URL.createObjectURL(s),l=document.createElement("a");l.href=r,l.download=n,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)}},xt=t=>{G(s=>{const n=new Set(s);return n.has(t)?n.delete(t):n.add(t),n})},gt=t=>{c==="view"?(T(t),G(new Set([t])),window.innerWidth<768&&J(!1)):xt(t)},mt=()=>{if(pe.close(),S.size===0)return;const t={...h,pages:h.pages.map(s=>S.has(s.id)?{...s,rotation:(s.rotation+90)%360}:s)};de(t)},pt=()=>{pe.close();const t={...h,pages:h.pages.map(s=>({...s,rotation:(s.rotation+90)%360}))};de(t)},ft=()=>{var n;if(fe.close(),S.size===0)return;const t=h.pages.filter(o=>!S.has(o.id)),s={...h,pages:t};t.some(o=>o.id===N)||T(((n=t[0])==null?void 0:n.id)||null),G(new Set),de(s)},wt=t=>{if(!Y||Y===t)return;const s=h.pages.findIndex(i=>i.id===Y),n=h.pages.findIndex(i=>i.id===t);if(s===-1||n===-1)return;const o=[...h.pages],[r]=o.splice(s,1);o.splice(n,0,r);const l={...h,pages:o};de(l)},yt=()=>{if(fe.close(),S.size===0){alert("請先選取要匯出的頁面。");return}const t=h.pages.filter(s=>S.has(s.id));Ae(t,`${F.replace(/\.pdf$/i,"")||"document"}_selection.pdf`)},bt=()=>{se.close(),ie?window.confirm("您有未儲存的變更。確定要關閉嗎？")&&j():j()},vt=()=>I(t=>Math.min(t+.1,5)),jt=()=>I(t=>Math.max(t-.1,.2)),Nt=()=>{I(1),B({x:0,y:0})},Me=d.useRef({handleSaveAndDownload:ze,handleUndo:$e,canUndo:Ee});Me.current={handleSaveAndDownload:ze,handleUndo:$e,canUndo:Ee},d.useEffect(()=>{const t=s=>{(s.ctrlKey||s.metaKey)&&s.key==="s"&&(s.preventDefault(),Me.current.handleSaveAndDownload()),(s.ctrlKey||s.metaKey)&&s.key==="z"&&(s.preventDefault(),Me.current.canUndo&&Me.current.handleUndo())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]);const kt=d.useCallback(t=>{t.stopPropagation();const s=t.deltaY>0?1:-1,n=h.pages.findIndex(l=>l.id===N);if(n===-1)return;const o=Math.max(0,Math.min(h.pages.length-1,n+s)),r=h.pages[o];r&&r.id!==N&&(T(r.id),G(new Set([r.id])),setTimeout(()=>{var l;(l=Re.current.get(r.id))==null||l.scrollIntoView({behavior:"smooth",block:"nearest"})},0))},[h.pages,N]),Ct=t=>{if(t.ctrlKey&&t.preventDefault(),Q){t.preventDefault();return}t.preventDefault();const s=t.deltaY*-.001;I(n=>Math.max(.2,Math.min(n+s,5)))},Ye=(t,s)=>{for(let n=s.length-1;n>=0;n--){const o=s[n],{sp:r,ep:l}=o,i=Math.min(r.x,l.x),x=Math.max(r.x,l.x),v=Math.min(r.y,l.y),L=Math.max(r.y,l.y);if(t.x>=i&&t.x<=x&&t.y>=v&&t.y<=L)return o}return null},He=t=>{const{sp:s,ep:n}=t,o=Math.min(s.x,n.x),r=Math.max(s.x,n.x),l=Math.min(s.y,n.y),i=Math.max(s.y,n.y);return{"top-left":{x:o,y:l},"top-right":{x:r,y:l},"bottom-left":{x:o,y:i},"bottom-right":{x:r,y:i}}},St=(t,s)=>{if(!s)return null;const n=He(s),o=8;for(const[r,l]of Object.entries(n))if(t.x>=l.x-o/2&&t.x<=l.x+o/2&&t.y>=l.y-o/2&&t.y<=l.y+o/2)return r;return null},we=t=>{const s=me.current,n=Ie.current;if(!s||!n)return{x:0,y:0};const o=n.getBoundingClientRect(),r="touches"in t?t.touches[0]:t,l=r.clientX,i=r.clientY,x=o.left+o.width/2,v=o.top+o.height/2;let L=l-x,V=i-v;const z=-P.rotation*(Math.PI/180),ne=L*Math.cos(z)-V*Math.sin(z),R=L*Math.sin(z)+V*Math.cos(z),oe=ne/b,he=R/b,re=n.clientWidth/2+oe,ae=n.clientHeight/2+he;return{x:re,y:ae}},Mt=t=>{var n;if(t.preventDefault(),X.show){(n=Oe.current)==null||n.blur();return}const s=we(t);if(Q)C==="text"?(K(null),Le({show:!0,x:s.x,y:s.y,value:""}),setTimeout(()=>{var o;return(o=Oe.current)==null?void 0:o.focus()},0)):(A({type:"drawing",startPoint:s}),K(null));else{const o=St(s,Se);if(o)A({type:"resizing",startPoint:s,handle:o,initialObject:Se});else{const r=Ye(s,P.objects);r?(K(r.id),A({type:"moving",startPoint:s,initialObject:r})):(K(null),A({type:"panning",panStartPoint:{x:t.clientX,y:t.clientY}}))}}},Pt=t=>{if(m.type==="panning"&&m.panStartPoint){const r=t.clientX-m.panStartPoint.x,l=t.clientY-m.panStartPoint.y;B(i=>({x:i.x+r,y:i.y+l})),A(i=>({...i,panStartPoint:{x:t.clientX,y:t.clientY}}));return}if(m.type==="idle")return;const s=we(t),{type:n,startPoint:o}=m;if(n==="drawing"&&o)le({id:"preview",type:C,sp:o,ep:s,color:te,strokeWidth:Ne});else if(n==="moving"&&m.initialObject){const r=s.x-o.x,l=s.y-o.y,{sp:i,ep:x}=m.initialObject,v={...m.initialObject,sp:{x:i.x+r,y:i.y+l},ep:{x:x.x+r,y:x.y+l}};le(v)}else if(n==="resizing"&&m.initialObject&&m.handle){const{sp:r,ep:l}=m.initialObject;let i={...r},x={...l};m.handle.includes("left")&&(i.x=s.x),m.handle.includes("right")&&(x.x=s.x),m.handle.includes("top")&&(i.y=s.y),m.handle.includes("bottom")&&(x.y=s.y);const v={...m.initialObject,sp:i,ep:x};le(v)}},Fe=t=>{if(m.type==="panning"){A({type:"idle"});return}if(m.type==="idle")return;const s=we(t),{type:n,startPoint:o}=m;let r=[...(P==null?void 0:P.objects)||[]],l=!1;if(n==="drawing"&&o&&(o.x!==s.x||o.y!==s.y)){const i={id:`obj_${Date.now()}`,type:C,sp:o,ep:s,color:te,strokeWidth:Ne};r.push(i),l=!0}else(n==="moving"||n==="resizing")&&H&&(r=r.map(i=>i.id===H.id?H:i),l=!0);if(l){const i={...h,pages:h.pages.map(x=>x.id===N?{...x,objects:r}:x)};de(i,{keepSelection:!0})}A({type:"idle"}),le(null)},Lt=t=>{if(t.touches.length===2){if(Q){t.preventDefault();return}t.preventDefault();const s=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);ce.current={isPinching:!0,initialDist:s,initialZoom:b},A({type:"idle"})}else if(t.touches.length===1){const s=t.touches[0],n=we(t);if(Q)C!=="text"&&(A({type:"drawing",startPoint:n}),K(null));else{const o=Ye(n,P.objects);o?(K(o.id),A({type:"moving",startPoint:n,initialObject:o})):(K(null),A({type:"panning",panStartPoint:{x:s.clientX,y:s.clientY}}))}}},Dt=t=>{if(ce.current.isPinching&&t.touches.length===2){if(Q)return;t.preventDefault();const n=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY)/ce.current.initialDist*ce.current.initialZoom;I(Math.max(.2,Math.min(n,5)))}else if(m.type==="panning"&&m.panStartPoint&&t.touches.length===1){const s=t.touches[0],n=s.clientX-m.panStartPoint.x,o=s.clientY-m.panStartPoint.y;B(r=>({x:r.x+n,y:r.y+o})),A(r=>({...r,panStartPoint:{x:s.clientX,y:s.clientY}}))}else if((m.type==="drawing"||m.type==="moving")&&t.touches.length===1){const s=we(t),{type:n,startPoint:o,initialObject:r}=m;if(n==="drawing"&&o)le({id:"preview",type:C,sp:o,ep:s,color:te,strokeWidth:Ne});else if(n==="moving"&&r){const l=s.x-o.x,i=s.y-o.y,{sp:x,ep:v}=r;le({...r,sp:{x:x.x+l,y:x.y+i},ep:{x:v.x+l,y:v.y+i}})}}},It=t=>{ce.current.isPinching?ce.current.isPinching=!1:Fe({})},Ot=()=>{const t=me.current,s=t==null?void 0:t.getContext("2d");if(X.value&&N&&s){const n=X.value,o=n.split(`
`),r=ke,l=De;s.font=`${r}px ${l}`;let i=0;o.forEach(E=>{const z=s.measureText(E);z.width>i&&(i=z.width)});const x=r*1.2,v=o.length*x,L={id:`obj_${Date.now()}`,type:"text",sp:{x:X.x,y:X.y},ep:{x:X.x+i,y:X.y+v},text:n,color:te,backgroundColor:ge,fontFamily:l,fontSize:r},V={...h,pages:h.pages.map(E=>E.id===N?{...E,objects:[...E.objects||[],L]}:E)};de(V)}Le({show:!1,x:0,y:0,value:""}),_("move")},Be=(t,s,n={})=>{const{scaleX:o=1,scaleY:r=1}=n,l={x:s.sp.x*o,y:s.sp.y*r},i={x:s.ep.x*o,y:s.ep.y*r};switch(t.strokeStyle=s.color||"red",t.fillStyle=s.color||"red",t.lineWidth=(s.strokeWidth||2)*o,s.type){case"line":t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(i.x,i.y),t.stroke();break;case"arrow":const x=Math.max(15,(s.strokeWidth||2)*3)*o,v=Math.atan2(i.y-l.y,i.x-l.x),L=i.x-x*Math.cos(Math.PI/6)*Math.cos(v),V=i.y-x*Math.cos(Math.PI/6)*Math.sin(v);t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(L,V),t.stroke(),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x-x*Math.cos(v-Math.PI/6),i.y-x*Math.sin(v-Math.PI/6)),t.lineTo(i.x-x*Math.cos(v+Math.PI/6),i.y-x*Math.sin(v+Math.PI/6)),t.closePath(),t.fill();break;case"rect":t.strokeRect(Math.min(l.x,i.x),Math.min(l.y,i.y),Math.abs(i.x-l.x),Math.abs(i.y-l.y));break;case"circle":t.beginPath();const E=Math.abs(i.x-l.x)/2,z=Math.abs(i.y-l.y)/2,ne=Math.min(l.x,i.x)+E,R=Math.min(l.y,i.y)+z;t.ellipse(ne,R,E,z,0,0,2*Math.PI),t.stroke();break;case"text":if(s.text){const oe=(s.fontSize||16)*r,he=s.fontFamily||"sans-serif";t.font=`${oe}px ${he}`,t.textBaseline="top";const re=s.text.split(`
`),ae=(s.fontSize||16)*1.2*r;s.backgroundColor&&s.backgroundColor!=="transparent"&&(t.fillStyle=s.backgroundColor,re.forEach((ye,be)=>{const Rt=t.measureText(ye).width;t.fillRect(l.x,l.y+be*ae,Rt,ae)})),t.fillStyle=s.color||"red",re.forEach((ye,be)=>{t.fillText(ye,l.x,l.y+be*ae)})}break}};return d.useEffect(()=>{const t=me.current,s=Ie.current,n=t==null?void 0:t.getContext("2d");if(!n||!t||!s||!P)return;const{clientWidth:o,clientHeight:r}=s;t.width!==o||t.height!==r?(t.width=o,t.height=r):n.clearRect(0,0,t.width,t.height),(H?P.objects.filter(x=>x.id!==H.id):P.objects).forEach(x=>Be(n,x)),H&&Be(n,H);const i=H&&H.id===Pe?H:Se;if(i){const{sp:x,ep:v}=i,L=Math.min(x.x,v.x),V=Math.min(x.y,v.y),E=Math.abs(x.x-v.x),z=Math.abs(x.y-v.y);n.strokeStyle="rgba(0, 123, 255, 0.7)",n.lineWidth=1,n.setLineDash([5,5]),n.strokeRect(L,V,E,z),n.setLineDash([]);const ne=He(i);n.fillStyle="white",n.strokeStyle="black",n.lineWidth=1,Object.values(ne).forEach(R=>{n.fillRect(R.x-4,R.y-4,8,8),n.strokeRect(R.x-4,R.y-4,8,8)})}},[P,Pe,Se,H,b,Z,nt]),d.useEffect(()=>{const t=me.current;t&&(Q?t.style.cursor="crosshair":m.type==="moving"?t.style.cursor="grabbing":m.type==="resizing"?t.style.cursor="nwse-resize":m.type==="panning"?t.style.cursor="grabbing":t.style.cursor="grab")},[C,m.type,Q]),e.jsxs("div",{className:"flex flex-col h-screen bg-gray-900",children:[xe&&e.jsxs("div",{className:"absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"}),e.jsx("p",{className:"text-white mt-4",children:"處理中，請稍候..."})]}),e.jsxs("header",{className:"bg-gray-800 shadow-md z-40 relative flex flex-col",children:[e.jsxs("div",{className:"relative flex items-center h-14 px-3 border-b border-gray-700",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-2 overflow-hidden",children:[e.jsx("button",{onClick:()=>J(!U),className:"md:hidden p-1.5 text-gray-300 hover:text-white hover:bg-gray-700 rounded mr-1 shrink-0",children:e.jsx(Qt,{className:"w-6 h-6"})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 md:gap-4 shrink-0",children:[e.jsx("h2",{className:"text-xs md:text-sm font-semibold tabular-nums whitespace-nowrap",children:c==="view"?`頁面 (${Ce>-1?Ce+1:0}/${h.pages.length})`:`已選取 ${S.size}`}),e.jsx("button",{onClick:()=>u(t=>t==="view"?"select":"view"),className:`p-2 md:p-2.5 rounded hover:bg-gray-700 ${c==="select"?"text-blue-400":"text-gray-400"}`,title:c==="view"?"切換至多選模式":"切換至檢視模式",children:c==="view"?e.jsx(Ze,{className:"w-5 h-5 md:w-6 md:h-6"}):e.jsx(Ve,{className:"w-5 h-5 md:w-6 md:h-6"})})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",ref:se.ref,children:[e.jsxs("button",{onClick:se.toggle,className:"flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white transition-colors","aria-haspopup":"true","aria-expanded":se.isOpen,children:[e.jsx(Qe,{className:"w-4 h-4"})," ",e.jsx("span",{className:"hidden md:inline",children:"檔案"})]}),se.isOpen&&e.jsxs("div",{className:"absolute left-0 mt-2 w-56 bg-gray-700 rounded-md shadow-lg py-1 z-50 border border-gray-600",children:[e.jsx("a",{href:"#",onClick:t=>{t.preventDefault(),ze()},className:"block px-4 py-2 text-sm text-white hover:bg-gray-600",children:"儲存並下載 PDF (Ctrl+S)"}),e.jsxs("a",{href:"#",onClick:t=>{t.preventDefault(),ut()},className:"flex items-center gap-2 px-4 py-2 text-sm text-white hover:bg-gray-600",children:[e.jsx(Xt,{className:"w-4 h-4"})," 儲存並分享"]}),e.jsx("a",{href:"#",onClick:t=>{t.preventDefault(),bt()},className:"block px-4 py-2 text-sm text-white hover:bg-gray-600",children:"關閉"})]})]}),e.jsxs("div",{className:"relative",ref:pe.ref,children:[e.jsxs("button",{onClick:pe.toggle,className:"flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white transition-colors",title:"旋轉",children:[e.jsx(et,{className:"w-4 h-4"})," ",e.jsx("span",{className:"hidden md:inline",children:"旋轉"})]}),pe.isOpen&&e.jsxs("div",{className:"absolute left-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-50 border border-gray-600",children:[e.jsxs("button",{onClick:mt,disabled:S.size===0,className:"w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 disabled:opacity-50",children:["旋轉選取 90° (",S.size,")"]}),e.jsx("a",{href:"#",onClick:t=>{t.preventDefault(),pt()},className:"block px-4 py-2 text-sm text-white hover:bg-gray-600",children:"全部旋轉 90°"})]})]}),e.jsxs("div",{className:"relative",ref:fe.ref,children:[e.jsxs("button",{onClick:fe.toggle,className:"flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white transition-colors",title:"分割/刪除",children:[e.jsx(Yt,{className:"w-4 h-4"})," ",e.jsx("span",{className:"hidden md:inline",children:"分割/刪除"})]}),fe.isOpen&&e.jsxs("div",{className:"absolute left-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-50 border border-gray-600",children:[e.jsxs("button",{onClick:ft,disabled:S.size===0,className:"w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 disabled:opacity-50",children:["刪除選取 (",S.size,")"]}),e.jsxs("button",{onClick:yt,disabled:S.size===0,className:"w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 disabled:opacity-50",children:["匯出選取 (",S.size,")"]})]})]})]}),e.jsxs("div",{className:"flex-1 flex items-center justify-end gap-2",children:[f&&e.jsx("span",{className:"hidden md:inline text-green-400 text-sm animate-pulse ml-2",children:"已儲存!"}),e.jsx("div",{className:"font-bold text-white truncate max-w-[100px] md:max-w-xs",children:F})]})]}),e.jsx("div",{className:"flex items-center justify-center px-3 py-2 bg-gray-900/50 overflow-x-auto no-scrollbar",children:e.jsxs("div",{className:"flex items-center gap-3 md:gap-4 min-w-max",children:[e.jsxs("div",{className:"flex items-center gap-1 border-r border-gray-600 pr-3",children:[e.jsx("button",{onClick:$e,disabled:!Ee,className:"p-2 hover:bg-gray-700 rounded-full disabled:opacity-30",title:"上一步 (Ctrl+Z)",children:e.jsx(_t,{className:"w-5 h-5"})}),e.jsx("button",{onClick:dt,disabled:!ht,className:"p-2 hover:bg-gray-700 rounded-full disabled:opacity-30",title:"下一步",children:e.jsx(At,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>_("move"),title:"移動",className:`p-2 rounded-full ${C==="move"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(Ht,{className:"w-5 h-5"})," "]}),e.jsxs("button",{onClick:()=>_("line"),title:"直線",className:`p-2 rounded-full ${C==="line"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(Vt,{className:"w-5 h-5"})," "]}),e.jsxs("button",{onClick:()=>_("arrow"),title:"箭頭",className:`p-2 rounded-full ${C==="arrow"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(Zt,{className:"w-5 h-5"})," "]}),e.jsxs("button",{onClick:()=>_("rect"),title:"方形",className:`p-2 rounded-full ${C==="rect"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(Kt,{className:"w-5 h-5"})," "]}),e.jsxs("button",{onClick:()=>_("circle"),title:"圓形",className:`p-2 rounded-full ${C==="circle"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(Gt,{className:"w-5 h-5"})," "]}),e.jsxs("button",{onClick:()=>_("text"),title:"文字",className:`p-2 rounded-full ${C==="text"?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[" ",e.jsx(qt,{className:"w-5 h-5"})," "]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-3 pl-3 border-l border-gray-600",children:[e.jsx("input",{type:"color",value:te,onChange:t=>rt(t.target.value),className:"w-8 h-8 rounded bg-transparent cursor-pointer border-none p-0"}),C!=="text"&&e.jsx("div",{className:"flex items-center gap-1",children:[2,5,10].map(t=>e.jsx("button",{onClick:()=>at(t),className:`w-6 h-6 flex items-center justify-center rounded-full ${Ne===t?"bg-gray-600":""}`,children:e.jsx("div",{className:"bg-white rounded-full",style:{width:`${Math.min(t+2,14)}px`,height:`${Math.min(t+2,14)}px`}})},t))}),C==="text"&&e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:ke,onChange:t=>it(parseInt(t.target.value,10)),className:"bg-gray-700 border border-gray-600 rounded w-10 md:w-12 px-1 text-sm text-center text-white"}),e.jsx("span",{className:"text-xs text-gray-400 hidden md:inline",children:"px"})]}),e.jsxs("select",{value:De,onChange:t=>lt(t.target.value),className:"bg-gray-700 text-white border border-gray-600 rounded text-xs md:text-sm h-8 px-1 max-w-[80px] md:max-w-[120px]",children:[e.jsx("option",{value:"sans-serif",children:"Sans Serif"}),e.jsx("option",{value:"serif",children:"Serif"}),e.jsx("option",{value:"monospace",children:"Mono"}),e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"})]}),e.jsxs("div",{className:"flex items-center gap-2 border-l border-gray-600 pl-2 md:pl-3",children:[e.jsxs("label",{className:"flex items-center gap-1 text-xs text-gray-300 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",checked:ge!=="transparent",onChange:t=>Ue(t.target.checked?"#ffffff":"transparent"),className:"rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-0 w-3 h-3 md:w-4 md:h-4"}),e.jsx("span",{className:"hidden md:inline",children:"背景"})]}),ge!=="transparent"&&e.jsx("input",{type:"color",value:ge,onChange:t=>Ue(t.target.value),className:"w-6 h-6 md:w-8 md:h-8 rounded bg-transparent cursor-pointer border-none p-0",title:"背景顏色"})]})]})]})]})})]}),e.jsxs("div",{className:"flex-grow flex overflow-hidden relative",children:[U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden",onClick:()=>J(!1)}),e.jsxs("aside",{ref:ct,className:`
                        flex-shrink-0 bg-gray-800 overflow-y-auto transition-transform duration-300 ease-in-out z-40
                        fixed inset-y-0 left-0 w-64 shadow-2xl transform
                        ${U?"translate-x-0":"-translate-x-full"}
                        md:relative md:translate-x-0 md:w-56 md:shadow-none md:block
                    `,onWheel:kt,children:[e.jsxs("div",{className:"md:hidden flex items-center justify-between p-3 border-b border-gray-700 bg-gray-800 sticky top-0 z-10",children:[e.jsx("h2",{className:"text-sm font-semibold text-white tabular-nums",children:c==="view"?`頁面 (${Ce>-1?Ce+1:0}/${h.pages.length})`:`已選取 ${S.size}`}),e.jsx("button",{onClick:()=>u(t=>t==="view"?"select":"view"),className:`p-2 rounded hover:bg-gray-700 ${c==="select"?"text-blue-400":"text-gray-400"}`,title:c==="view"?"切換至多選模式":"切換至檢視模式",children:c==="view"?e.jsx(Ze,{className:"w-5 h-5"}):e.jsx(Ve,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-1 gap-2 p-2 pb-20 md:pb-0",children:h.pages.map(t=>e.jsxs("div",{ref:s=>{s?Re.current.set(t.id,s):Re.current.delete(t.id)},draggable:!0,onDragStart:()=>W(t.id),onDragOver:s=>s.preventDefault(),onDrop:()=>wt(t.id),onDragEnd:()=>W(null),className:`relative aspect-square group cursor-pointer border-2 bg-gray-900/50 rounded-md overflow-hidden ${S.has(t.id)?"border-blue-500":"border-transparent"} ${Y===t.id?"opacity-50":""}`,onClick:()=>gt(t.id),children:[e.jsx("img",{src:M.get(t.id),className:"w-full h-full object-contain",style:{transform:`rotate(${t.rotation}deg)`}}),e.jsx("div",{className:"absolute bottom-0 right-0 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded-tl",children:h.pages.findIndex(s=>s.id===t.id)+1})]},t.id))})]}),e.jsxs("main",{className:"flex-1 p-4 flex flex-col bg-gray-900 relative overflow-hidden",onWheel:Ct,children:[e.jsx("div",{className:"flex-grow overflow-hidden flex items-center justify-center",children:P?e.jsxs("div",{className:"relative touch-none select-none",style:{transform:`translate(${Z.x}px, ${Z.y}px) scale(${b})`,transition:"transform 0.2s ease-in-out",transformOrigin:"center center"},children:[e.jsx("img",{ref:Ie,src:M.get(P.id),className:"max-w-full max-h-full object-contain shadow-lg transition-transform duration-200 pointer-events-none",style:{transform:`rotate(${P.rotation}deg)`},onLoad:()=>ot(t=>t+1)}),e.jsx("canvas",{ref:me,className:"absolute top-0 left-0 pointer-events-auto z-10",style:{transform:`rotate(${P.rotation}deg)`},onMouseDown:Mt,onMouseMove:Pt,onMouseUp:Fe,onMouseLeave:Fe,onTouchStart:Lt,onTouchMove:Dt,onTouchEnd:It}),X.show&&e.jsx("textarea",{ref:Oe,value:X.value,onChange:t=>Le(s=>({...s,value:t.target.value})),onBlur:Ot,className:"absolute border p-1 z-20 overflow-auto resize whitespace-pre",style:{left:X.x*b,top:X.y*b,fontSize:ke*b,fontFamily:De,color:te,borderColor:te,backgroundColor:ge,transform:`rotate(${P.rotation}deg)`,transformOrigin:"top left",minWidth:`${100*b}px`,minHeight:`${ke*1.5*b}px`}})]}):e.jsx("p",{className:"text-gray-500",children:"沒有頁面可顯示"})}),P&&e.jsxs("div",{className:"absolute bottom-6 right-6 z-30 bg-gray-800/90 backdrop-blur-sm rounded-full flex items-center text-white shadow-xl border border-gray-700",children:[e.jsx("button",{onClick:jt,className:"p-3 hover:bg-gray-700 rounded-full transition-colors",title:"縮小",children:e.jsx(Tt,{className:"w-5 h-5"})}),e.jsxs("span",{className:"px-1 text-sm font-mono font-semibold w-12 text-center tabular-nums",children:[Math.round(b*100),"%"]}),e.jsx("button",{onClick:Nt,className:"p-3 hover:bg-gray-700 rounded-full transition-colors",title:"恢復 100%",children:e.jsx(Jt,{className:"w-5 h-5"})}),e.jsx("button",{onClick:vt,className:"p-3 hover:bg-gray-700 rounded-full transition-colors",title:"放大",children:e.jsx(qe,{className:"w-5 h-5"})})]})]})]})]})},ns=()=>{const[a,D]=d.useState([]),[j,p]=d.useState(null),[w,y]=d.useState(!1),[O,h]=d.useState([]),[M,k]=d.useState(!1),[$,S]=d.useState([]),[G,Y]=d.useState(!1),W=d.useCallback(async()=>{try{const c=await ue.getProjectsMetadata();D(c)}catch(c){console.error("Failed to load projects",c)}},[]);d.useEffect(()=>{W()},[W]);const xe=async c=>{Y(!0);try{const u=await c.arrayBuffer(),N=await Ge({data:u}).promise,T=[];for(let I=1;I<=N.numPages;I++){const Z=await N.getPage(I),B=Z.getViewport({scale:1}),U=document.createElement("canvas"),J=U.getContext("2d");if(!J)continue;U.width=B.width,U.height=B.height;const C={canvasContext:J,viewport:B,canvas:U};await Z.render(C).promise;const _=await new Promise(m=>U.toBlob(m,"image/jpeg",Te.NORMAL));_&&T.push({id:`page_${Date.now()}_${I}`,data:_,rotation:0,objects:[]})}const b={id:`proj_${Date.now()}`,name:c.name.replace(/\.pdf$/i,""),pages:T,timestamp:Date.now()};await ue.saveProject(b),await W(),p(b)}catch(u){console.error("Error creating project:",u),alert("建立專案失敗。")}finally{Y(!1)}},q=async c=>{Y(!0);try{const u=[],N=c.sort((b,I)=>b.name.localeCompare(I.name,void 0,{numeric:!0,sensitivity:"base"}));for(let b=0;b<N.length;b++){const I=N[b];I.type.startsWith("image/")&&u.push({id:`page_${Date.now()}_${b}`,data:I,rotation:0,objects:[]})}if(u.length===0){alert("請選擇有效的圖片檔案。");return}const T={id:`proj_img_${Date.now()}`,name:c.length===1?c[0].name.split(".")[0]:`圖片專案 ${new Date().toLocaleDateString()}`,pages:u,timestamp:Date.now()};await ue.saveProject(T),await W(),p(T)}catch(u){console.error("Error creating project from images:",u),alert("建立專案失敗。")}finally{Y(!1)}},F=async c=>{const u=await ue.getProjectData(c);u&&p(u)},je=async(c,u)=>{u.stopPropagation(),confirm("您確定要刪除此專案嗎？")&&(await ue.deleteProject(c),await W())},ie=async(c,u)=>{const N={...c,timestamp:Date.now()};u&&(N.name=u),await ue.saveProject(N),await W(),j&&j.id===c.id?p(N):j||p(N)},ee=async c=>{const u=c.target.files;u&&u.length>0&&(u.length===1&&u[0].type==="application/pdf"?await xe(u[0]):await q(Array.from(u))),c.target.value=""},f=c=>{c.target.files&&c.target.files.length>0&&(h(Array.from(c.target.files)),y(!0),k(!1)),c.target.value=""},g=c=>{S(c),k(!0),y(!1)};return j?e.jsx(ss,{project:j,onSave:ie,onClose:()=>{p(null),W()}}):M?e.jsx(ts,{sortedFiles:$,onSave:async c=>{await ie(c),k(!1),p(c)},onCancel:()=>k(!1)}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white p-8",children:[G&&e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"}),e.jsx("p",{className:"text-white mt-4",children:"處理中，請稍候..."})]}),w&&e.jsx(es,{files:O,onCancel:()=>y(!1),onConfirm:g}),e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("header",{className:"flex flex-col md:flex-row items-center justify-between mb-10 border-b border-gray-700 pb-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500",children:"PDF 編輯與合併工具"}),e.jsx("p",{className:"text-gray-400 mt-1",children:"在瀏覽器中直接管理、編輯與合併您的 PDF 文件，安全無虞。"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 transition-colors",children:[e.jsx("input",{type:"file",accept:"application/pdf",multiple:!0,onChange:f,className:"hidden"}),e.jsx(tt,{className:"w-5 h-5"}),"合併 PDF"]}),e.jsxs("label",{className:"cursor-pointer bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded flex items-center gap-2 transition-colors shadow-lg shadow-blue-900/50",children:[e.jsx("input",{type:"file",accept:"application/pdf, image/png, image/jpeg, image/jpg",multiple:!0,onChange:ee,className:"hidden"}),e.jsx(qe,{className:"w-5 h-5"}),"新增專案"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[a.map(c=>e.jsxs("div",{onClick:()=>F(c.id),className:"bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-blue-500 cursor-pointer transition-all hover:shadow-xl hover:shadow-blue-900/20 group relative",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsx("div",{className:"p-3 bg-gray-700 rounded-lg group-hover:bg-blue-900/30 group-hover:text-blue-400 transition-colors",children:e.jsx(Qe,{className:"w-8 h-8"})}),e.jsx("button",{onClick:u=>je(c.id,u),className:"p-2 text-gray-500 hover:text-red-400 hover:bg-red-900/20 rounded-full transition-colors opacity-0 group-hover:opacity-100",title:"刪除專案",children:e.jsx(Je,{className:"w-5 h-5"})})]}),e.jsx("h3",{className:"font-bold text-lg truncate mb-1",title:c.name,children:c.name}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-400",children:[e.jsxs("span",{children:[c.pageCount," 頁"]}),e.jsx("span",{children:new Date(c.timestamp).toLocaleDateString()})]})]},c.id)),a.length===0&&e.jsxs("div",{className:"col-span-full text-center py-20 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:[e.jsx("div",{className:"mb-4 mx-auto w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center",children:e.jsx(Ut,{className:"w-8 h-8 text-gray-600"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-400",children:"尚未建立專案"}),e.jsx("p",{className:"max-w-md mx-auto mt-2",children:"上傳 PDF 開始編輯，或選取多個 PDF 進行合併。"})]})]})]})]})},st=document.getElementById("root");if(!st)throw new Error("Could not find root element to mount to");const os=$t.createRoot(st);os.render(e.jsx(Et.StrictMode,{children:e.jsx(ns,{})}));
